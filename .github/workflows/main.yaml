name: Velist CI/CD Pipeline

on:
  push:
    branches: [ "main", "master", "develop" ]
    paths-ignore:
      - '**.md'
      - '.gitignore'
  pull_request:
    branches: [ "main", "master", "develop" ]

jobs:
  # ============================================================
  # 阶段 1: 代码质量检查 (运行于 PR 和 Push)
  # ============================================================
  check-code-quality:
    name: Code Quality Check
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./velist
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v3

      - name: Setup Flutter
        uses: subosito/flutter-action@v2
        with:
          channel: 'stable'
          cache: true

      - name: Install Dependencies
        run: flutter pub get

      - name: Run Build Runner (Hive Adapters)
        run: dart run build_runner build --delete-conflicting-outputs

      - name: Run Static Analysis
        run: flutter analyze

      - name: Run Tests
        run: flutter test

  # ============================================================
  # 阶段 2: 构建与部署 (仅运行于 Push)
  # ============================================================

  build-web-docker:
    name: Build Web & Push Docker
    needs: check-code-quality
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./velist
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          cache: true
      
      - run: flutter pub get
      
      - run: dart run build_runner build --delete-conflicting-outputs
      
      - run: flutter build web --release

      - name: Login to DockerHub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_PASSWORD }}
      
      - name: Build and Push Web Image
        uses: docker/build-push-action@v4
        with:
          context: ./velist
          file: ./velist/Dockerfile
          push: true
          tags: ${{ secrets.DOCKERHUB_USERNAME }}/velist:latest

  build-android:
    name: Build Android APK
    needs: check-code-quality
    if: github.event_name == 'push'
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: ./velist
    steps:
      - uses: actions/checkout@v3

      - uses: actions/setup-java@v3
        with:
          distribution: 'zulu'
          java-version: '17'
          cache: 'gradle'
      
      - uses: subosito/flutter-action@v2
        with:
          cache: true
      
      - run: flutter pub get
      - run: dart run build_runner build --delete-conflicting-outputs
      - run: flutter build apk --release

      - name: Upload APK
        uses: actions/upload-artifact@v4
        with:
          name: release-apk
          path: velist/build/app/outputs/flutter-apk/app-release.apk

  build-windows:
    name: Build Windows Desktop
    needs: check-code-quality
    if: github.event_name == 'push'
    runs-on: windows-latest
    defaults:
      run:
        working-directory: ./velist
    steps:
      - uses: actions/checkout@v3
      - uses: subosito/flutter-action@v2
        with:
          cache: true
      
      - run: flutter config --enable-windows-desktop
      - run: flutter pub get
      - run: dart run build_runner build --delete-conflicting-outputs
      - run: flutter build windows --release
      
      - name: Archive Windows Build
        run: compress-archive -Path build\windows\x64\runner\Release\* -DestinationPath velist-windows.zip
        
      - name: Upload Windows Build
        uses: actions/upload-artifact@v4
        with:
          name: release-windows
          path: velist/velist-windows.zip